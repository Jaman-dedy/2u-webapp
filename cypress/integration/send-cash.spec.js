/* eslint-disable no-undef */
const pin = '5007';
const username = 'AGO';
const password = 'pppppppppp';

const contactsList = [
  {
    ContactType: 'INTERNAL',
    ContactPID: '250788211992',
    FirstName: 'tester',
    LastName: 'umoney',
    PresenceStatus: '0',
    AccountVerified: 'YES',
    PictureURL:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/250788211992-0.png',
    PictureURLmedium:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/250788211992medium-0.png',
    PictureURLsmall:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/250788211992small-0.png',
    CountryCode: 'RW',
    PhoneNumber: '250788211992',
    MainPhonePrefix: '250',
    MainPhoneNumber: '788 211 992',
    MainPhoneFlag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
    Phones: [
      {
        Phone: '250788211992',
        PhonePrefix: '250',
        PhoneNumber: '788 211 992',
        NumberCountryCode: 'RW',
        PhoneFlag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
        Category: 'Private',
        CategoryCode: '1',
      },
    ],
    EMail: '@',
    DefaultWallet: {
      WalletNumber: 'USD-01-250788211992',
      WalletName: 'Personal',
      Currency: 'USD',
      Flag:
        'https://celinemoneypicfiles.blob.core.windows.net/icons/us.png',
    },
    Favorite: 'NO',
    MySharedWalletsCount: '2',
    MySharedWallets: [
      {
        WalletNumber: 'AED-05-LAFOUINEBABY',
        WalletName: 'USER1',
        Currency: 'AED',
        Balance: '5,139 AED',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/ae.png',
      },
      {
        WalletNumber: 'USD-04-LAFOUINEBABY',
        WalletName: 'testingCard04',
        Currency: 'USD',
        Balance: '109 USD',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/us.png',
      },
    ],
    BankAccountCount: '0',
    BankAccounts: [],
  },
  {
    ContactType: 'INTERNAL',
    ContactPID: 'AGO',
    FirstName: 'Alberto Gerardo',
    LastName: 'Olympio',
    PresenceStatus: '3',
    AccountVerified: 'NO',
    PictureURL:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/ago-1.png',
    PictureURLmedium:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/agomedium-0.png',
    PictureURLsmall:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/agosmall-0.png',
    CountryCode: 'SN',
    PhoneNumber: '221777979343',
    MainPhonePrefix: '221',
    MainPhoneNumber: '77 797 93 43',
    MainPhoneFlag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/sn.png',
    Phones: [
      {
        Phone: '+221777979343',
        PhonePrefix: '221',
        PhoneNumber: '77 797 93 43',
        NumberCountryCode: 'sn',
        PhoneFlag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/sn.png',
        Category: 'Private',
        CategoryCode: '1',
      },
    ],
    EMail: 'alberto@ossix.technology',
    DefaultWallet: {
      WalletNumber: 'SLL-01-AGO',
      WalletName: 'Rokel Demo',
      Currency: 'SLL',
      Flag:
        'https://celinemoneypicfiles.blob.core.windows.net/icons/sl.png',
    },
    WalletsCount: '4',
    Wallets: [
      {
        WalletNumber: 'EUR-01-AGO',
        WalletName: 'Operations',
        Currency: 'EUR',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/eur.png',
      },
      {
        WalletNumber: 'RWF-01-AGO',
        WalletName: 'Rwanda Op',
        Currency: 'RWF',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
      },
      {
        WalletNumber: 'USD-01-AGO',
        WalletName:
          'Investments in the cloud bor are good you broke me first',
        Currency: 'USD',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/us.png',
      },
      {
        WalletNumber: 'XOF-01-AGO',
        WalletName: 'Personal',
        Currency: 'XOF',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/xof.png',
      },
    ],
    Favorite: 'NO',
    MySharedWalletsCount: '1',
    MySharedWallets: [
      {
        WalletNumber: '',
        Currency: '',
        Balance: '0 ',
        Flag: '',
      },
    ],
    BankAccountCount: '0',
    BankAccounts: [],
  },
  {
    ContactType: 'INTERNAL',
    ContactPID: 'ALAINB',
    FirstName: 'Alain',
    LastName: 'burindi',
    PresenceStatus: '4',
    AccountVerified: 'NO',
    PictureURL:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/alainb-0.png',
    PictureURLmedium:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/alainbmedium-0.png',
    PictureURLsmall:
      'https://celinemoneypicfiles.blob.core.windows.net/zones/alainbsmall-0.png',
    CountryCode: 'Rw',
    PhoneNumber: '250781368921',
    MainPhonePrefix: '250',
    MainPhoneNumber: '781 368 921',
    MainPhoneFlag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
    Phones: [
      {
        Phone: '250781368921',
        PhonePrefix: '250',
        PhoneNumber: '781 368 921',
        NumberCountryCode: 'Rw',
        PhoneFlag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
        Category: 'Private',
        CategoryCode: '1',
      },
    ],
    EMail: 'alainburindi62@gmail.com',
    DefaultWallet: {
      WalletNumber: 'RWF-01-ALAINB',
      WalletName: 'Personal',
      Currency: 'RWF',
      Flag:
        'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
    },
    Favorite: 'NO',
    MySharedWalletsCount: '2',
    MySharedWallets: [
      {
        WalletNumber: 'RWF-02-LAFOUINEBABY',
        WalletName: 'testingWallet',
        Currency: 'RWF',
        Balance: '898,601 RWF',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
      },
      {
        WalletNumber: 'USD-02-LAFOUINEBABY',
        WalletName: 'testingCard01',
        Currency: 'USD',
        Balance: '19 USD',
        Flag:
          'https://celinemoneypicfiles.blob.core.windows.net/icons/us.png',
      },
    ],
    BankAccountCount: '0',
    BankAccounts: [],
  },
];

const mockGetAllContacts = () => {
  cy.route({
    method: 'POST',
    url: '/GetAllContactList',
    status: 200,
    response: contactsList,
  }).as('getAllContacts');
};

const mockGetFavoriteList = () => {
  cy.route({
    method: 'POST',
    url: '/GetFavoriteList',
    status: 200,
    response: contactsList,
  }).as('getFavorite');
};

const countries = [
  {
    CountryCode: 'CD',
    CountryName: 'Democratic Republic of the Congo',
    PhoneAreaCode: '243',
    MainCurrency: 'CDF',
    Flag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/cd.png',
    Currencies: [
      {
        '01': 'CDF',
        Main: 'Yes',
      },
    ],
  },
  {
    CountryCode: 'CM',
    CountryName: 'Cameroon',
    PhoneAreaCode: '237',
    MainCurrency: 'XAF',
    Flag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/cm.png',
    Currencies: [
      {
        '01': 'XAF',
        Main: 'Yes',
      },
    ],
  },
  {
    CountryCode: 'NA',
    CountryName: 'Namibia',
    PhoneAreaCode: '264',
    MainCurrency: 'NAD',
    Flag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/na.png',
    Currencies: [
      {
        '01': 'NAD',
        Main: 'Yes',
      },
      {
        '02': 'USD',
        Main: 'No',
      },
    ],
  },
  {
    CountryCode: 'RW',
    CountryName: 'Rwanda',
    PhoneAreaCode: '250',
    MainCurrency: 'RWF',
    Flag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/rw.png',
    Currencies: [
      {
        '01': 'EUR',
        Main: 'No',
      },
      {
        '02': 'RWF',
        Main: 'Yes',
      },
      {
        '03': 'USD',
        Main: 'No',
      },
    ],
  },
  {
    CountryCode: 'SN',
    CountryName: 'Senegal',
    PhoneAreaCode: '221',
    MainCurrency: 'XOF',
    Flag:
      'https://celinemoneypicfiles.blob.core.windows.net/icons/sn.png',
    Currencies: [
      {
        '01': 'XOF',
        Main: 'Yes',
      },
    ],
  },
];
const mockOssixCountries = () => {
  cy.route({
    method: 'POST',
    url: '/OssixCountries',
    status: 200,
    response: countries,
  }).as('getCountries');
};

const mockSendCash = error => {
  cy.route({
    method: 'POST',
    url: '/SendCash',
    status: error ? 401 : 200,
    response: error
      ? [
          {
            Error: '2014',
            Description: 'Wrong PIN number',
            UserLoginCorrect: 'FALSE',
          },
        ]
      : [
          {
            OK: '200',
            Description:
              'Funds sent and the wallets are updated. Notification is sent to both parties.',
            Result: 'Success',
            AmountSent: '0.00 RWF',
            Amount: '1.00 SLL',
            Fees: '0.00 SLL',
            ExternalFees: '0.00 SLL',
            ExchangeFees: '0.01 SLL',
            Taxes: '0.00 SLL',
            TotalAmount: '1.01 SLL',
            ExchangeRate: '1:0.000000',
            TransferNumber: '46 82 40 72 69',
            SecurityCode: '86 79',
            VoucherQRCode:
              'http://chart.apis.google.com/chart?chs=200x200&cht=qr&chld=M&chl=46824072698679',
            SourceWallet: {
              WalletNumber: 'SLL-01-AGO',
              Balance: '24916158',
              WalletName: 'Rokel Demo',
              Currency: 'SLL',
              Flag:
                'https://celinemoneypicfiles.blob.core.windows.net/icons/sl.png',
            },
          },
        ],
  }).as('sendCash');
};

const mockTransferConfirmation = error => {
  cy.route({
    method: 'POST',
    url: '/TransferConfirmation',
    status: error ? 401 : 200,
    response: error
      ? [
          {
            Error: '2022',
            Description:
              'You do not have enough money in this wallet for this operation(24916158)',
            Result: 'FAILED',
          },
        ]
      : [
          {
            OK: '200',
            TargetAccountVerified: 'YES',
            AccountName: '',
            AccountCurrency: '',
            Description:
              'Funds are available. All clear for this transaction.',
            Result: 'Success',
            AmountToBeSent: '1.00 RWF',
            Amount: '1.00 RWF',
            Fees: '0.00 RWF',
            ExternalFees: '0.00 RWF',
            ExchangeFees: '0.00 RWF',
            Taxes: '0.00 RWF',
            TotalAmount: '1.00 RWF',
            ExchangeRate: '1:1.000000',
          },
        ],
  }).as('confirmTransaction');
};

const fillAmountField = value => {
  cy.get('input[name="amount"]').type(`${value}`);
};

// Opens transfer amount form and populates the amount field if a value is provided
const showAmountForm = amount => {
  cy.get(':nth-child(2) > :nth-child(2) > button', {
    timeout: 60000,
  }).click({ force: true });
  mockGetAllContacts();
  mockGetFavoriteList();
  mockOssixCountries();
  cy.get('a[href="/contacts?ref=send-cash"]').click({
    force: true,
  });

  cy.get('div.contact-item', { timeout: 60000 })
    .last()
    .click({
      force: true,
    });
  if (!Number.isNaN(amount)) {
    fillAmountField(amount);
  }
};

const submitAmountForm = () => {
  cy.get('.actions button.ui.positive.button').click();
};

const fillRecurringForm = (startDateIndex = 3, endDateIndex = 4) => {
  cy.get('.one-tme-transfer .toggle-switch-switch').click();
  cy.get('.ui.search.dropdown>input.search').type('2nd');
  cy.get('.visible > :nth-child(1) > .text').click();

  cy.get('input[name="startDate"]').focus();
  cy.get(
    `:nth-child(${startDateIndex}) > :nth-child(3) > .suicr-content-item`,
  ).click({ force: true });

  cy.get('input[name="endDate"]').focus();
  cy.get(
    `:nth-child(${endDateIndex}) > :nth-child(3) > .suicr-content-item`,
  )
    .last()
    .click({ force: true });
};

describe('Test Send Cash to contact', () => {
  before(() => {
    cy.clearLocalStorageSnapshot();
    cy.loginAs(username, password, pin);
    cy.saveLocalStorage();
  });
  beforeEach(() => {
    cy.server();
    cy.restoreLocalStorage();
    cy.visit('/contacts?ref=send-cash');
  });

  afterEach(() => {
    cy.saveLocalStorage();
  });

  it('Should send cash to contact', () => {
    showAmountForm(1);

    cy.location('pathname').should('eq', '/contacts');

    cy.get('div.select-contact').should(
      'have.text',
      'Select a contact',
    );

    mockTransferConfirmation();
    submitAmountForm();

    // fill pin form
    cy.enterPin(pin);
    cy.get('.ss-amount strong').should('contain.text', '1');

    mockSendCash();
    cy.get('button.ui.positive.button').click();
    cy.get('.ss-amount strong').should('not.be.visible');
  });

  it('Should not transfer the amount of money less than or equal to zero', () => {
    showAmountForm(0);

    cy.get('div.select-contact').should(
      'have.text',
      'Select a contact',
    );
    submitAmountForm();
    cy.location('pathname').should('eq', '/contacts');

    cy.get('.message-component span')
      .first()
      .should('have.text', 'The amount cannot be zero');
  });

  it('Should not send amount of money greater than wallet balance.', () => {
    showAmountForm();

    cy.get('input[name="amount"]').type(1000000000);
    mockTransferConfirmation('error');

    submitAmountForm();

    cy.get('.message-component span')
      .first()
      .should(
        'contain',
        'You do not have enough money in this wallet for this',
      );
  });

  it('Should raise an error if the amount field has no value.', () => {
    showAmountForm();
    submitAmountForm();

    cy.get('.message-component span')
      .first()
      .should(
        'contain',
        'You must enter the amount for this operation.',
      );
  });

  it('Should be able to send money from any wallet', () => {
    showAmountForm();
    cy.get(
      ':nth-child(1) > .rightItems > .dropdown > :nth-child(1) > .caret',
    ).click();
    cy.get(
      '.visible > .scrolling > :nth-child(2) > .dropdown-trigger',
    ).click();

    fillAmountField(1);
    mockTransferConfirmation();
    submitAmountForm();

    cy.enterPin(pin);
    mockSendCash();
    cy.get('button.ui.positive.button')
      .first()
      .click({ force: true });
    cy.get('.Toastify__toast-body', {
      timeout: 20000,
    }).should('contain', 'Notification is sent to both parties.');
  });

  it('Should be able create recurring transactions', () => {
    showAmountForm(1);
    mockTransferConfirmation();

    submitAmountForm();

    fillRecurringForm();
    cy.enterPin(pin);
    mockSendCash();
    cy.get('button.ui.positive.button').click();

    // wait for the toast and check it's content
    cy.get('.Toastify__toast-body', { timeout: 20000 }).should(
      'contain',
      'Notification is sent to both parties.',
    );
  });

  it('Should be able create recurring transactions and send cash directly', () => {
    showAmountForm(1);
    mockTransferConfirmation();
    submitAmountForm();

    fillRecurringForm();

    cy.get('.send-now  .toggle-switch-switch').click();

    cy.enterPin(pin);
    mockSendCash();

    cy.get('button.ui.positive.button').click();

    // check if the amount div is not visible, which means the transfer
    // has been successful and the modal has dismissed
    cy.get('.ss-amount strong').should('not.be.visible');
  });

  it('Should not allow starting date to be greater than ending date. ', () => {
    showAmountForm(1);
    mockTransferConfirmation();
    submitAmountForm();

    fillRecurringForm(4, 3);
    cy.enterPin(pin);
    cy.get('button.ui.positive.button').click();

    cy.get('.message-component span').should(
      'contain',
      'Please choose an end date that is later than the start date',
    );
  });

  it('Should not submit transfer money form without a pin.', () => {
    showAmountForm(1);
    mockTransferConfirmation();
    submitAmountForm();

    fillRecurringForm();

    cy.get('button.ui.positive.button').click();

    cy.get('.message-component span').should(
      'contain',
      'Please provide your PIN number.',
    );
  });

  it('Should not submit transfer money form without a correct pin.', () => {
    showAmountForm(1);
    mockTransferConfirmation();
    submitAmountForm();

    fillRecurringForm();
    cy.enterPin('0000');
    mockSendCash('error');
    cy.get('button.ui.positive.button').click();

    // wait for the toast and check it's content
    cy.get('.message-component span', { timeout: 20000 }).should(
      'contain',
      'Wrong PIN',
    );
  });
});
